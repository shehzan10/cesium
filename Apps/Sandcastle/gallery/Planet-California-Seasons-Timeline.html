<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="Use Viewer to start building new applications or easily embed Cesium into existing applications.">
    <meta name="cesium-sandcastle-labels" content="Beginner, Showcases">
    <title>Cesium Demo</title>
    <script type="text/javascript" src="../Sandcastle-header.js"></script>
    <script type="text/javascript" src="../../../ThirdParty/requirejs-2.1.20/require.js"></script>
    <script type="text/javascript">
    require.config({
        baseUrl : '../../../Source',
        waitSeconds : 60
    });
    </script>
</head>
<body class="sandcastle-loading" data-sandcastle-bucket="bucket-requirejs.html">
<style>
    @import url(../templates/bucket.css);
    #toolbar {
        background: rgba(42, 42, 42, 0.8);
        padding: 4px;
        border-radius: 4px;
    }
    #toolbar input {
        vertical-align: middle;
        padding-top: 2px;
        padding-bottom: 2px;
    }
    #toolbar table tr {
        transform: translateY(0);
        transition: transform 0.4s ease-out;
    }
</style>
<div id="cesiumContainer" class="fullSize">
</div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar">
    <h3>Timeline blend of California 2014 Fall to 2015 Summer<br>(With Landsat tileset as globe)</h3>
    <hr>
    <h3 id="lightingAndShadowsMenu">Lighting Options </h3>
    <hr>
    <table>
        <h3>Image Layer Adjustments</h3>
        <tbody>
        <tr>
            <td>Brightness</td>
            <td>
                <input type="range" min="0" max="3" step="0.02" data-bind="value: brightness, valueUpdate: 'input'">
                <input type="text" size="5" data-bind="value: brightness">
            </td>
        </tr>
        <tr>
            <td>Contrast</td>
            <td>
                <input type="range" min="0" max="3" step="0.02" data-bind="value: contrast, valueUpdate: 'input'">
                <input type="text" size="5" data-bind="value: contrast">
            </td>
        </tr>
        <tr>
            <td>Hue</td>
            <td>
                <input type="range" min="0" max="3" step="0.02" data-bind="value: hue, valueUpdate: 'input'">
                <input type="text" size="5" data-bind="value: hue">
            </td>
        </tr>
        <tr>
            <td>Saturation</td>
            <td>
                <input type="range" min="0" max="3" step="0.02" data-bind="value: saturation, valueUpdate: 'input'">
                <input type="text" size="5" data-bind="value: saturation">
            </td>
        </tr>
        <tr>
            <td>Gamma</td>
            <td>
                <input type="range" min="0" max="3" step="0.02" data-bind="value: gamma, valueUpdate: 'input'">
                <input type="text" size="5" data-bind="value: gamma">
            </td>
        </tr>
        </tbody>
    </table>
    <hr>
    <h3  id="cameraToolbar">Load and Save Camera Views<br><br></h3>
</div>
<script id="cesium_sandcastle_script">
function startup(Cesium) {
    'use strict';
//Sandcastle_Begin
var viewer = new Cesium.Viewer('cesiumContainer', {
    imageryProvider : undefined,
    baseLayerPicker : false,
    shadows : true,
    terrainShadows : Cesium.ShadowMode.ENABLED
});

viewer.shadows = false;
viewer.terrainShadows = Cesium.ShadowMode.DISABLED;

var imageryLayers = viewer.imageryLayers;

////////////////////////////////////////////////
// Camera Prebaked
function setCameraFlyTo(destination, direction, up) {
    viewer.camera.flyTo({
        destination : destination,
        orientation : {
            direction : direction,
            up : up
        }
    });
}

var destination;
var direction;
var up;

var cameraTargets = [{
    text : 'California',
    onselect : function() {
        destination = new Cesium.Cartesian3(-3154349.7576250844, -5463494.0450492175, 4815256.562280628);
        direction = new Cesium.Cartesian3(0.3964679528791864, 0.6867026379595742, -0.6093050544342704);
        up = new Cesium.Cartesian3(0.3046525272171354, 0.5276736557943383, 0.7929359057583726);
        setCameraFlyTo(destination, direction, up);
    }
}, {
    text : 'San Francisco',
    onselect : function() {
        destination = new Cesium.Cartesian3(-2702787.3643543134, -4262368.815146929, 3888397.746987569);
        direction = new Cesium.Cartesian3(-0.6124830084274882, 0.6143086060972998, -0.497483166411092);
        up = new Cesium.Cartesian3(-0.7890691837896355, -0.4374938791376783, 0.43124114937077274);
        setCameraFlyTo(destination, direction, up);
    }
}, {
    text : 'Mount Whitney',
    onselect : function() {
        destination = new Cesium.Cartesian3(-2428855.298182562, -4523934.398080078, 3778475.9690342858);
        direction = new Cesium.Cartesian3(-0.4541084582175541, 0.8623510198116858, 0.2239112029466627);
        up = new Cesium.Cartesian3(-0.5462922719536546, -0.468035456206207, 0.6946276451002811);
        setCameraFlyTo(destination, direction, up);
    }
}, {
    text : 'Sandstone Peak',
    onselect : function() {
        destination = new Cesium.Cartesian3(-2556091.0838058814, -4634580.391742086, 3556176.0257374737);
        direction = new Cesium.Cartesian3(-0.1173958816602729, 0.9810546470152239, 0.1541103064011027);
        up = new Cesium.Cartesian3(-0.5735158639457153, -0.1936651319411379, 0.7959732222083992);
        setCameraFlyTo(destination, direction, up);
    }
}, {
    text : 'Mount San Antonio',
    onselect : function() {
        destination = new Cesium.Cartesian3(-2444661.8985863435, -4682805.014845039, 3570024.096528283);
        direction = new Cesium.Cartesian3(-0.3068852658342115, 0.8516919085569485, 0.42478503565037207);
        up = new Cesium.Cartesian3(-0.4842861280787656, -0.5239601906198418, 0.7006658724357115);
        setCameraFlyTo(destination, direction, up);
    }
}, {
    text : 'Mount Shasta',
    onselect : function() {
        destination = new Cesium.Cartesian3(-2547888.938998508, -4060246.2635382377, 4199748.287392013);
        direction = new Cesium.Cartesian3(-0.6906874706543586, 0.6700254696261853, -0.2720600814770413);
        up = new Cesium.Cartesian3(-0.664995888197215, -0.44066186491723325, 0.6029905384734187);
        setCameraFlyTo(destination, direction, up);
    }
}];

var cameraMenu = Sandcastle.addToolbarMenu(cameraTargets, 'cameraToolbar');

Sandcastle.addToolbarButton('Save Current View', function() {
    var camera = viewer.scene.camera;
    var index = cameraTargets.length;
    cameraTargets.push({
        text : 'Saved Camera ' + index,
        position: camera.position.clone(),
        direction: camera.direction.clone(),
        up : camera.up.clone(),
        onselect : function() {
            viewer.camera.flyTo({
                destination : this.position,
                orientation : {
                    direction : this.direction,
                    up : this.up
                }
            });
        }
    });
    var addOption = document.createElement('option');
    addOption.textContent = cameraTargets[index].text;
    addOption.value = cameraTargets[index].value;
    cameraMenu.appendChild(addOption);
    cameraMenu.selectedIndex = index;
}, 'cameraToolbar');
////////////////////////////////////////////////

////////////////////////////////////////////////
// Base Layers
// Clear all default layers
imageryLayers.removeAll(false);

var planet_api_key = '?api_key=dfa8215647244cec9ba8855978089349';
var planetMapsLayer = imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({
    url : 'https://tiles.planet.com/v0/mosaics/landsat8_toa_rgb_mosaic/{z}/{x}/{y}.png' + planet_api_key
}));
viewer.scene.frameState.creditDisplay.addDefaultCredit(
    new Cesium.Credit('Â© Imagery provided by Planet.com', '../images/PlanetMaps.png', 'https://www.planet.com')
);
////////////////////////////////////////////////

////////////////////////////////////////////////
// California Seasonal
var californiaSeasons = [
    'california_re_20140901_20141130',
    'california_re_20141201_20150228',
    'california_re_20150301_20150531',
    'california_re_20150601_20150831'
];
var californiaLayers = [];

for(var i = 0; i < californiaSeasons.length; ++i) {
    californiaLayers.push(imageryLayers.addImageryProvider(
        new Cesium.UrlTemplateImageryProvider({
            url : 'https://tiles.planet.com/v0/mosaics/open_' + californiaSeasons[i] + '/{z}/{x}/{y}.png' + planet_api_key
        })
    ));
    californiaLayers[i].alpha = 0;
}
////////////////////////////////////////////////

////////////////////////////////////////////////
// Terrain
var cesiumTerrainProviderMeshes = new Cesium.CesiumTerrainProvider({
    url : 'https://assets.agi.com/stk-terrain/world',
    requestWaterMask : false,
    requestVertexNormals : true
});
viewer.terrainProvider = cesiumTerrainProviderMeshes;
////////////////////////////////////////////////

////////////////////////////////////////////////
// 3D Tiles
var tileset = new Cesium.Cesium3DTileset({
    url: "https://beta.cesiumcontent.com/api/assets/486?access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIwZDlkODZhMy1lNWUxLTQ1ZDAtOWJiYS1kZTRlOTE5YzJjZDEiLCJpZCI6OCwiaWF0IjoxNDczNDQyNDIxfQ.iIrl-RnpbKV_XBDUpdqpc-vRpMf2y-tEF0aDCtRYSJg"
});
viewer.scene.primitives.add(tileset);
////////////////////////////////////////////////

////////////////////////////////////////////////
// US State Borders
var stateBorders = viewer.dataSources.add(Cesium.GeoJsonDataSource.load('../../SampleData/ne_10m_us_states.topojson', {
        stroke: Cesium.Color.BLACK,
        fill: Cesium.Color.BLACK.withAlpha(0.0),
        strokeWidth: 5
    }));
////////////////////////////////////////////////

////////////////////////////////////////////////
// GUI
var lightingAndShadowsMenu = [{
    text : 'None',
    onselect : function() {
        viewer.scene.globe.enableLighting = false;
        viewer.shadows = false;
        viewer.terrainShadows = Cesium.ShadowMode.DISABLED;
    }
}, {
    text : 'Lighting Only',
    onselect : function() {
        viewer.scene.globe.enableLighting = true;
        viewer.shadows = false;
        viewer.terrainShadows = Cesium.ShadowMode.DISABLED;
    }
}, {
    text : 'Lighting and Shadows',
    onselect : function() {
        viewer.scene.globe.enableLighting = true;
        viewer.shadows = true;
        viewer.terrainShadows = Cesium.ShadowMode.ENABLED;
    }
}];

Sandcastle.addToolbarMenu(lightingAndShadowsMenu, 'lightingAndShadowsMenu');

function setLayerAlphas(newValue) {
    var alphaThis = 1 - Math.min(Math.max(Math.abs(newValue % 1 - 0.5) - 1/6, 0), 1/3) * 1.5;
    var indexThis = Math.floor(newValue);
    var indexOther = newValue % 1 < 0.5 ? indexThis - 1 : indexThis + 1;
    indexOther = Math.min(Math.max(indexOther, 0), californiaLayers.length - 1);
    for(var i = 0; i < californiaLayers.length; i++) {
        californiaLayers[i].alpha = 0.0;
    }
    californiaLayers[indexThis].alpha = alphaThis;
    if(indexOther !== indexThis) {
        californiaLayers[indexOther].alpha = 1 - alphaThis;
        imageryLayers.raiseToTop(californiaLayers[indexOther]);

    } else {
        californiaLayers[indexThis].alpha = 1;
    }
    imageryLayers.raiseToTop(californiaLayers[indexThis]);
}

// The viewModel tracks the state of our mini application.
var viewModel = {
    brightness: 0,
    contrast: 0,
    hue: 0,
    saturation: 0,
    gamma: 0
};
// Convert the viewModel members into knockout observables.
Cesium.knockout.track(viewModel);

// Bind the viewModel to the DOM elements of the UI that call for it.
var toolbar = document.getElementById('toolbar');
Cesium.knockout.applyBindings(viewModel, toolbar);
function subscribeLayerParameter(name) {
    Cesium.knockout.getObservable(viewModel, name).subscribe(
        function(newValue) {
            for(var i = 0; i < imageryLayers.length; ++i) {
                var layer = imageryLayers.get(i);
                layer[name] = newValue;
            }
        }
    );
}
subscribeLayerParameter('brightness');
subscribeLayerParameter('contrast');
subscribeLayerParameter('hue');
subscribeLayerParameter('saturation');
subscribeLayerParameter('gamma');

// Set defaults
viewModel.brightness = imageryLayers.get(0).brightness;
viewModel.contrast = imageryLayers.get(0).contrast;
viewModel.hue = imageryLayers.get(0).hue;
viewModel.saturation = imageryLayers.get(0).saturation;
viewModel.gamma = imageryLayers.get(0).gamma;
////////////////////////////////////////////////

////////////////////////////////////////////////
// Timeline
var start = Cesium.JulianDate.fromIso8601("2014-09-01");
var stop = Cesium.JulianDate.fromIso8601("2015-08-31");

viewer.clock.startTime = start.clone();
viewer.clock.stopTime = stop.clone();
viewer.clock.currentTime = start.clone();
viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP; //Loop at the end
viewer.clock.multiplier = 7 * 86400;

viewer.timeline.zoomTo(start, stop);
////////////////////////////////////////////////

////////////////////////////////////////////////
// Timeline activated imagery
var lastTick = start.clone();
var totalDays = Cesium.JulianDate.daysDifference(stop, start);
var ticker = viewer.clock.onTick;
ticker.addEventListener(function() {
    var diff = Cesium.JulianDate.daysDifference(viewer.clock.currentTime, lastTick);
    // Update imagery if difference is 1 days
    if(Math.abs(diff) > 1) {
        var daysFromStart = Cesium.JulianDate.daysDifference(viewer.clock.currentTime, start);
        var fraction = ((daysFromStart / totalDays) * californiaLayers.length).toFixed(2);
        var timelineFraction = Math.min(Math.max(fraction, 0), californiaLayers.length - 1);
        setLayerAlphas(timelineFraction);
        lastTick = viewer.clock.currentTime;
    }
});
////////////////////////////////////////////////
//Sandcastle_End
    Sandcastle.finishedLoading();
}
if (typeof Cesium !== "undefined") {
    startup(Cesium);
} else if (typeof require === "function") {
    require(["Cesium"], startup);
}
</script>
</body>
</html>
